# 文件审查系统 - 开发计划（更新版）

## 说明
- ✅ 严格按照阶段顺序执行；每小节完毕需自测+提交结果，等待确认后才能继续。
- ✅ 所有界面与文案保持中文，API/代码注释统一 UTF-8。
- ✅ 每阶段的产出需要保留对应的测试步骤/证据，方便回溯。

### 编码规范
- 后端 Java、XML、配置文件、前端 Vue/JS/TS/CSS 以及所有 Markdown 文档一律使用 **UTF-8（无 BOM）** 编码保存，禁止混用 ANSI、UTF-16 等格式。
- IDE/编辑器需设置默认编码为 UTF-8，命令行写文件时显式指定 `-Encoding utf8`（PowerShell）或 `--encoding=UTF-8` 等参数，确保批处理脚本不再写出乱码。
- 代码审查与 CI 阶段，如发现非 UTF-8 文件必须立即重存，并在提交说明中标注“编码修复”。

---

## 总体排期（基于 8h/天）
| 阶段 | 目标 | 预计工时 | 关键输出 |
| --- | --- | --- | --- |
| 第1阶段 | 环境 & 基础架构 | 2-3h | Docker、数据库脚本、项目骨架 |
| 第2阶段 | 认证与权限 | 3-4h | 登录/Token/路由守卫 |
| 第3阶段 | 租户+用户管理 | 3-4h | 租户 CRUD + 管理员 + 企业用户模块 |
| 第4阶段 | 文件上传与存储 | 4-5h | MinIO、MD5、前端上传组件 |
| 第5阶段 | 审查任务流程 | 5-6h | 任务/版本/审查 UI+API |
| 第6阶段 | 异步+性能 | 2-3h | RabbitMQ、Redis 缓存 |
| 第7阶段 | 集成测试与部署 | 2-3h | 测试报告、Docker 部署 |

---

## 第1阶段：环境与基础架构
### 1.1 Docker 运行环境
**产出**：docker-compose.yml、.env、README-Docker.md
- MySQL、Redis、MinIO、RabbitMQ 容器编排，含本地数据卷。
- .env 统一管理端口/用户名/密码（生产与开发分离）。
- Docker 文档包含：启动/停止、日志、常见问题。
**验证**：docker-compose up -d 成功运行四个服务；docker-compose ps 状态 healthy。

### 1.2 数据库初始化
**产出**：sql/schema.sql、sql/init-data.sql
- 建表（tenant、user、review_task、review_version、review_file）。
- 初始化平台超级管理员租户 & 管理员账号。
- 插入两个示例企业，含若干用户（企业管理员/审查员/普通用户）。
**验证**：在容器中执行 source schema.sql & source init-data.sql，用 SQL 校验表和初始数据。

### 1.3 后端项目骨架
**产出**：ackend/pom.xml、pplication.yml、ReviewApplication.java
- 配置 Spring Boot、MyBatis-Plus、Redis、MinIO、RabbitMQ、Knife4j。
- 统一响应 Result、异常处理 GlobalExceptionHandler、健康检查 /api/health。
- MyBatis-Plus 插件包含分页、多租户/逻辑删除配置。
**验证**：mvn clean install + mvn spring-boot:run，访问 /api/health 返回 SUCCESS。

### 1.4 前端项目骨架
**产出**：rontend/package.json、ite.config.js、src/main.js、src/App.vue
- Vite + Vue3 + Element Plus（全局中文 locale）+ Pinia + Vue Router。
- Axios 封装 src/utils/request.js，统一携带 Token 和错误提示。
- 提供基础布局组件入口。
**验证**：
pm install、
pm run dev，访问 http://localhost:5173 显示基础布局；控制台无报错。

---

## 第2阶段：用户认证与授权
### 2.1 后端认证模块
**产出**：entity/User.java、mapper/UserMapper.java、service/AuthService.java、controller/AuthController.java
- BCrypt 密码保存、JWT 生成/解析工具、登录失败提示。
- Spring Security / 拦截器放行白名单（登录/文档/健康检查）。
- 提供修改密码、获取当前用户信息接口。
**验证**：使用 Postman 登录、获取用户信息；错误密码场景返回业务错误。

### 2.2 登录页面
**产出**：iews/Login.vue、pi/auth.js、store/user.js
- Element Plus 表单（用户名/密码），提交时 loading、错误提示中文。
- Pinia 存储 token、用户信息、当前角色（支持多角色）。
- 登录成功跳转默认角色页面。
**验证**：使用 dmin/admin123 登录 → 浏览器跳转平台后台；localStorage 保存 token/userInfo/currentRole。

### 2.3 路由守卫与布局
**产出**：outer/index.js、layouts/*
- 针对平台/企业/审查员/普通用户的路由与菜单，未授权自动跳转。
- 顶栏支持角色切换、修改密码、退出。
- 404/403 页面及中文提示。
**验证**：登录后访问无权限路由 → 弹出“没有权限”提示并跳回默认页；未登录访问业务路由 → 重定向 login。

---

## 第3阶段：租户与用户管理
### 3.1 租户管理（平台）
**产出**：controller/TenantController.java、service/TenantService.java、mapper/TenantMapper.java、controller/TenantAdminController.java、dto/Tenant*.java、iews/platform/TenantManagement.vue、pi/tenant.js

**后端任务**
1. 租户 CRUD + 参数校验（名称唯一、配额 ≥ 已用、状态切换限制）。
2. 提供管理员接口供平台在租户创建后随时新建/重置管理员（用户名/真实姓名/手机号/初始密码，若失败可单独重试，不影响租户）。
3. 平台管理员接口：
   - 列表：GET /api/tenant/{id}/admins
   - 新增：POST /api/tenant/{id}/admin
   - 重置密码：POST /api/tenant/{id}/admin/{adminId}/reset
   - 启用/禁用：PUT /api/tenant/{id}/admin/{adminId}/status
4. 操作审计日志（添加/重置/启停记录管理员）。

**前端任务**
1. 租户列表 + 筛选（状态/名称）、分页、分页组件中文化。
2. 创建/编辑租户对话框：仅包含企业信息字段（联系人/配额等），验证提示中文。
3. 租户详情抽屉：显示联系人、配额进度条、管理员列表及操作按钮。
4. 管理员管理弹窗：新增/编辑、重置密码、启用/禁用、确认对话框按钮“确定/取消”（管理员创建在此模块完成，可多次重试）。

**测试**
1. 创建租户“测试企业”+ 管理员 dmin_test → API 返回租户 ID & 管理员 ID。
2. 使用新管理员登录企业后台成功。
3. 管理员列表可新增第二个管理员、重置密码后可用、禁用后禁止登录。
4. 停用租户 → 该租户管理员登录返回“租户已停用”。

**补充**
- Excel 导出列表（企业信息、配额、状态）。
- 租户操作日志查询接口（平台可查）。

### 3.2 用户管理（企业管理员）
**产出**：controller/UserController.java、service/UserService.java、mapper/UserMapper.java、dto/User*.java、config/CurrentTenantResolver.java、iews/admin/UserManagement.vue、pi/user.js

**后端任务**
1. 企业管理员用户接口（URL 需显式区分操作，避免仅靠 HTTP Method）：
   - 列表：GET `/api/admin/users/list`（分页 + 状态/角色/关键字筛选）
   - 新增：POST `/api/admin/users/create`
   - 编辑：PUT `/api/admin/users/{userId}`
   - 重置密码：POST `/api/admin/users/{userId}/reset-password`
   - 批量启用/禁用：PUT `/api/admin/users/status/batch`
   - 单个启用/禁用：PUT `/api/admin/users/{userId}/status`
2. 权限 & 隔离：
   - 只允许 `TENANT_ADMIN` 访问；所有操作自动绑定当前租户 `tenant_id`。
   - 用户名、手机号在租户内唯一；`role_tenant_admin` 不能与其它角色共存，`role_reviewer` 与 `role_user` 可组合（双角色）。
   - 当账号同时拥有审查员 + 普通用户角色时，登录后默认进入普通用户空间，可在顶部角色切换；后端返回 `roles:["REVIEWER","USER"]`，前端在用户管理列表显示“双角色”标签。
3. 业务校验：
   - 创建/启用前检查用户配额（`tenant.user_count < user_quota`），并在成功创建/删除时维护 `user_count`。
   - 被禁用用户登录返回“账号已停用”；所属租户停用时也不可登录。
   - 重置密码沿用 BCrypt，同步记录操作日志。
4. DTO/VO 需包含：基本信息、角色数组、最近登录时间、状态。重置/批量操作统一返回中文提示。

**前端任务**
1. `views/admin/UserManagement.vue`：表格 + 顶部筛选（角色多选、状态、搜索框），分页中文化。
2. 用户对话框：
   - 创建：用户名、真实姓名、手机号、角色（复选：企业管理员 / 审查员 / 普通用户）、初始密码。
   - 编辑：用户名不可修改；角色切换需联动互斥规则（选择企业管理员时禁用其他角色）。
3. 表格操作：编辑、重置密码、停用/启用（批量 + 单个），所有弹框按钮使用“确定/取消”中文。
4. 角色显示支持多标签；当用户同时拥有审查员+普通用户时，在列表和详情处提示“双角色，可在前台切换”。

**测试**
1. 企业管理员 `admin_a` 登录 → 创建用户 `zhangsan`，赋予审查员+普通用户角色 → 使用该账号登录，验证顶部角色切换功能。
2. 再创建用户 `lisi`，赋予企业管理员角色 → 尝试勾选普通用户/审查员应被自动取消，保存后只能以企业管理员身份登录。
3. 批量选择两个用户执行“停用” → 再次登录提示“账号已停用”；批量“启用”后恢复。
4. 用户配额用尽时创建提示“用户配额不足”；删除一个账号后重新创建成功。


---

## 第4阶段：文件上传与存储
### 4.1 MinIO 配置
- MinioConfig、MinioUtil，封装上传/下载/预签名 URL。
- Bucket 自动初始化；异常处理与日志。

### 4.2 Web Worker MD5
- public/workers/md5Worker.js + utils/md5.js 分片计算 MD5、进度回调、可取消。

### 4.3 文件上传接口
- FileController、FileService、ReviewFileMapper、ReviewFile 实体。
- 接口：检查 MD5、上传/秒传、列表、下载、预览、删除；校验 PDF/大小/存储配额。

### 4.4 前端上传组件
- components/FileUpload.vue，包含拖拽、MD5 进度、上传状态、失败重试、秒传提示。

**测试**：上传 200MB PDF → 展示“计算指纹/上传中”；再次上传同文件 → 秒传成功；非法格式/过大 → 中文错误提示。

---

## 第5阶段：审查任务管理
**产出**：ReviewTask/ReviewVersion 实体、ReviewTaskMapper、ReviewVersionMapper、TaskService、VersionService、ReviewTaskController、ReviewVersionController、ReviewActionController、Mongo/Redis 日志记录；前端 `views/user/CreateTask.vue`、`views/user/TaskList.vue`、`views/user/ResubmitTask.vue`、`views/reviewer/TaskList.vue`、`views/reviewer/ReviewTask.vue`、`views/shared/VersionHistoryDrawer.vue`、`api/task.js`。

### 5.1 创建任务（普通用户）
**后端任务**
1. 扩展 ReviewTask（creator_id、reviewer_id、current_version、current_status）和 ReviewVersion（version_number、status、files_ready、review_comment 等）字段，与第 4 阶段文件表建立关联。
2. 接口：
   - GET `/api/tasks/reviewers`：返回当前租户启用状态的审查员（含姓名、手机号、最近登录、角色标签）。
   - POST `/api/tasks`：参数=任务名称、审查员 ID、提交说明、文件 ID 列表。校验任务名在租户内唯一、审查员状态=启用、当前登录角色必须是 USER 或双角色切换到 USER。
3. 创建流程：创建 task（currentStatus=REVIEWING）→ 创建 version(v1, status=REVIEWING, filesReady=1) → 绑定文件 → 更新 task.currentVersion=1。

**前端任务**
1. `views/user/CreateTask.vue` 多步表单（基本信息、选择审查员、上传文件），联动第 4 阶段上传组件；支持保存草稿与重置。
2. `api/task.js` 补充 `fetchReviewers`、`createTask`；校验失败展示中文提示。

### 5.2 任务列表与详情
**后端接口**
1. GET `/api/tasks/mine`  
   - 支持分页、状态（REVIEWING/APPROVED/REJECTED）、关键字、时间范围筛选。  
   - 仅返回 `creator_id = 当前用户` 的记录，限制跨租户访问。  
   - 结果字段需附带：`currentVersion`、`currentStatus` 中文文案、审查员姓名+电话、最近一次版本更新时间、文件数量。  
   - 根据筛选条件统计“本月提交数/通过数”返回给前端顶部卡片。
2. GET `/api/tasks/reviewer`  
   - 同样支持分页/状态/关键字。  
   - 仅返回 `reviewer_id = 当前用户` 的任务，并提供发起人信息、待处理版本号、待处理天数等指标。  
   - 增加“仅查看待审查”布尔开关，默认筛选 `current_status = REVIEWING`。
3. GET `/api/tasks/{taskId}`  
   - 权限：任务发起人或指派审查员可查；超租户访问给出 `BUSINESS_ERROR`。  
   - 返回字段：任务基本信息、当前版本详情（版本号、提交说明、文件列表）、审查员资料、历史操作时间线（创建→审查→再次提交）。  
   - 若任务状态为 REJECTED，附带上一版审查意见，供前端展示“再次提交”入口。
4. GET `/api/tasks/{taskId}/versions`  
   - 返回所有版本列表，按版本号倒序；字段包含 `versionId、status、filesReady、fileCount、submitDesc、reviewComment、reviewTime、reviewerName`。  
   - 当 `filesReady=0` 时，补充 `progressMsg` 说明仍在复制中，用于前端提示。  
5. `/api/tasks/stat`（新增，可与列表接口合并返回）  
   - 输出“累计发起/通过/被驳回次数、近 30 天趋势”供仪表盘使用。  
   - 统计 SQL 需走索引（按 tenant_id、creator_id、status）并缓存 60s。

**前端页面**
1. `views/user/TaskList.vue`  
   - 顶部 3 张统计卡片（累计发起、通过率、本月任务），下方为筛选区域（状态多选、时间范围、关键字）与表格。  
   - 表格列：任务名、审查员、当前版本、状态标签、最近更新、文件数、操作。操作按钮含“查看详情”“再次提交”（仅 REJECTED）。  
   - 集成版本历史抽屉，点击任务名即可打开；列表空态需展示“去创建任务”按钮跳转 `/user/create-task`。
2. `views/reviewer/TaskList.vue`  
   - 使用 Element Plus Tabs 构建“全部/待办/已完成”三视图，切换时重新请求 `/api/tasks/reviewer`。  
   - 支持搜索发起人/任务名、状态筛选、快速筛选最近 7 天任务。  
   - 列表操作为“开始审查”与“查看详情”；若 `current_status != REVIEWING` 则禁用开始按钮并展示提示。
3. `views/shared/TaskDetailDrawer.vue`（新增）  
   - 双列布局：左侧展示任务/版本基本信息与审查阶段时间线，右侧嵌入 `FileUpload` 只读模式 + 审查意见。  
   - 底部根据身份（用户/审查员）渲染操作按钮（再次提交、开始审查等）。  
4. `views/shared/VersionHistoryDrawer.vue`  
   - 与 5.1 复用文件接口：列表展示所有版本，点击行展开文件清单，提供预览/下载。  
   - 当 `filesReady=0` 时显示进度条与轮询提示（2 秒轮询一次 `/api/version/{id}/status`）。

**测试要点**
1. 普通用户仅能看到本人任务；切换账号验证跨租户访问受限。  
2. 审查员列表标签切换、筛选条件组合测试（状态+关键字+时间）；确认分页与统计数据同步刷新。  
3. 历史版本抽屉在 filesReady=0/1 时 UI 不同；再次提交按钮只在 REJECTED 状态展示，点击后跳转 5.4 流程。

### 5.3 审查操作（审查员）
**后端**
1. GET `/api/review/{versionId}`：返回版本详情、提交说明、文件列表、上一版本信息。
2. POST `/api/review/{versionId}/approve`、`/reject`：参数=审查意见；校验任务状态=REVIEWING 且 reviewer=当前用户；更新 version.review_result、review_comment、review_time、reviewer_id，并同步更新 task.current_status、current_version。
3. 记录操作日志（taskId、versionId、结果、时长），供后续 6 阶段监控使用。

**前端**
1. `views/reviewer/ReviewTask.vue`：左右分栏（左=文件预览列表，右=提交说明/文件列表/审查意见输入）；底部按钮“通过”“打回”，含 `ElMessageBox` 二次确认。
2. 操作成功后自动跳转回待办列表并刷新数据。

### 5.4 再次提交/版本复制
**后端**
1. POST `/api/tasks/{taskId}/resubmit`：参数=旧版本 ID、新提交说明、新文件 ID 列表、是否复用旧文件。
2. 流程：校验任务状态=REJECTED、creator=当前用户 → 创建新版本(v+1, status=REVIEWING, files_ready=0) → 将新上传文件绑定到新版本 → 若复用旧文件，向 RabbitMQ `file.copy.queue` 发送 `{taskId, oldVersionId, newVersionId}`，消费者复制 `review_file` 元数据并设置 files_ready=1 → 更新 task.current_version/status=REVIEWING。
3. 提供 GET `/api/version/{versionId}/status` 供前端轮询复制进度（每 2s，最多 60s）。

**前端**
1. 任务详情在状态=已打回时展示“再次提交”按钮，进入 `views/user/ResubmitTask.vue`：显示上一版本审查意见、文件列表，勾选“沿用旧文件”时只提交 resubmit 请求，不重新上传。
2. 提交后进入轮询模式，展示进度条与提示，复制完成后跳转回任务详情。

### 测试
1. 普通用户创建任务+上传文件 → 审查员列表仅显示本租户启用用户，创建成功版本 v1 状态=审查中。
2. 普通用户只能看到自己任务、审查员只能看到指派任务；跨租户访问接口返回“无权访问”。
3. 审查员打回 → 用户再次提交 → 版本号递增、状态回到审查中；审查员通过后任务/版本状态=已通过，历史版本只读、文件可预览/下载。
4. 再次提交复用文件 → RabbitMQ 复制完成时 `files_ready` 由 0 → 1，前端轮询提示“文件已就绪”；删除任务最后引用的文件后，MinIO 对象被清理且租户存储使用量减少。

---

## 第6阶段：RabbitMQ 与性能优化
**产出**：`config/RabbitConfig.java`、`mq/FileCopyMessage.java`、`mq/FileCopyProducer.java`、`mq/FileCopyConsumer.java`、`service/FileAsyncService.java`、`config/RedisCacheConfig.java`、`common/RateLimiter.java`、`views/monitor/QueuePanel.vue`、`views/monitor/CachePanel.vue`

### 6.1 RabbitMQ 文件复制异步化
1. **基础配置**
   - 定义 `review.exchange`、`file.copy.queue`、`file.copy.dlx` 与路由键 `file.copy`；consumer 并发由 `spring.rabbitmq.listener.simple.concurrency` 控制。
   - 消息体 `FileCopyMessage`：taskId、tenantId、oldVersionId、newVersionId、重试次数、traceId；所有 producer 调用 `FileCopyProducer.send(message)`。
   - `FileCopyProducer` 统一设置过期时间（30s）与 Header（traceId、source），方便追踪。
2. **消费流程**
   - `FileCopyConsumer` 监听 `file.copy.queue`，执行：查询旧版本文件 → 批量复制数据库记录 & MinIO 对象 → 更新新版本 `files_ready=1 / file_count` → 写入 `file_copy_log`。
   - 复制失败时区分可重试与不可重试异常：可重试 `nack` 并写回队列（Header- retry--），超过 5 次或不可重试直接投递到死信队列；DLX 消费者记录 `rabbitmq_error_log` 并触发企业微信/邮件告警。
   - 提供 `/api/monitor/queues` 读取 RabbitMQ HTTP API，返回 ready/unacked 消息数、消费者数量、堆积级别；前端 `QueuePanel` 以红/黄提示瓶颈。
3. **自测**
   - 触发“复用旧文件”的再次提交，确认版本 `files_ready` 在文件复制结束前为 0，成功后变为 1。
   - 模拟 MinIO copy 抛错，查看 DLX 告警与版本状态被标记为 `files_ready=-1`，前端提示“复制失败，请重试”。
   - 手动压测 1000 条消息，确认消费速率与日志记录 traceId，可用于排查。

### 6.2 Redis 缓存与限流
1. **登录与接口限流**
   - `LOGIN_FAIL:<username>` 记录 15 分钟内的失败次数（>5 次锁定 30 分钟），登录成功即删除；在 AuthController 返回剩余锁定时间。
   - `RateLimiter` 基于 Redis + Lua，实现 `/api/tasks` 等接口的 QPS 控制（默认 30 req/min/用户）。
2. **热点数据缓存**
   - `/api/tasks/reviewers`、`/api/tenant/list` 等下拉项使用 `@Cacheable(value="options", key="...")`，TTL 10 分钟，附加 ±20% 漂移；更新租户/用户后调用 `CacheEvict`。
   - 任务统计 `/api/tasks/mine/stat`、`/reviewer/stat` 缓存 60s，键包含 tenantId+userId；发生任务新增/审核结果变化时主动清除。
3. **缓存雪崩/穿透防护**
   - 对不存在的任务详情写入空值缓存（TTL 30s）避免穿透；在登录、创建任务等关键接口加入布隆过滤器或空值缓存策略。
   - 使用 Redisson 分布式锁控制同一任务的统计刷新、防止同一数据被多实例同时复制。
4. **监控 & 自测**
   - `/api/monitor/cache` 输出缓存命中率、热点 Key、Redis 内存占用；`CachePanel` 以折线图展示。
   - 压测 `/api/tasks/mine/stat`，观察日志中的命中率提升；Redis 控制台能看到随机过期时间、空值 key。
   - 连续输错密码 5 次后收到锁定提示，Redis 中 `LOGIN_FAIL` key 计数正确。

---

## 第7阶段：测试与部署
### 7.1 功能测试
- 按完整业务流：平台建租户 → 创建管理员 → 企业管理员建用户 → 普通用户创建任务 → 审查员处理 → 再次提交。
- 权限用例：跨租户访问失败、被禁用用户无法登录。
- 性能用例：并发上传、批量任务列表。
- 输出 测试报告.md（用例、结果、缺陷）。

### 7.2 Docker 部署
- 前后端 Dockerfile、多阶段构建，docker-compose.prod.yml：Nginx + 后端 + MySQL/Redis/MinIO/RabbitMQ。
- 部署文档：环境变量、日志、备份、回滚步骤。
- 验证：docker-compose -f docker-compose.prod.yml up -d；访问前端首页与 /api/health 成功。

---

> 若在执行过程中发现需求新增或调整，需同步更新本计划并重新评估工期。
